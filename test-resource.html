<!DOCTYPE html>
<html>
<head>
  <title>Resource Loading Test</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      line-height: 1.6;
    }
    h1, h2 { color: #333; }
    .section {
      margin: 30px 0;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
    pre {
      background: #f0f0f0;
      padding: 10px;
      border-radius: 3px;
      overflow-x: auto;
      font-size: 12px;
    }
    button {
      padding: 8px 16px;
      background-color: #0078d7;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background-color: #0063b1;
    }
    .card {
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 15px;
      margin-bottom: 15px;
      background: #f9f9f9;
    }
    .debug-info {
      font-size: 12px;
      color: #666;
      margin-top: 10px;
      font-family: monospace;
    }
    .input-group {
      margin-bottom: 15px;
    }
    .input-group input {
      padding: 8px;
      width: 100%;
      border: 1px solid #ddd;
      border-radius: 3px;
      box-sizing: border-box;
    }
    .success {
      color: #155724;
      background-color: #d4edda;
      padding: 10px;
      border-radius: 3px;
      margin-bottom: 10px;
    }
    .error {
      color: #721c24;
      background-color: #f8d7da;
      padding: 10px;
      border-radius: 3px;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <h1>Resource Loading Test</h1>
  <p>This page is designed to test various resource loading scenarios with the Scope3 worker.</p>
  
  <div class="debug-info">
    <strong>Debug Info:</strong>
    <br>Page loaded at: <span id="load-time"></span>
    <br>Current URL: <span id="current-url"></span>
  </div>
  
  <div class="section">
    <h2>Test Resource Loading</h2>
    <p>This section tests loading JSON resources from different paths.</p>
    
    <div class="input-group">
      <label for="resource-url">Resource URL:</label>
      <input type="text" id="resource-url" value="/test-resource.json">
    </div>
    
    <button id="load-resource">Load Resource</button>
    <div id="resource-result" class="card" style="margin-top: 15px; display: none;"></div>
  </div>
  
  <div class="section">
    <h2>Common Test URLs</h2>
    <p>Click these buttons to test loading from predefined URLs:</p>
    
    <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px;">
      <button class="test-url-btn" data-url="/test-resource.json">Local Path</button>
      <button class="test-url-btn" data-url="http://localhost:8787/test-resource.json">Localhost:8787</button>
      <button class="test-url-btn" data-url="http://localhost:8788/test-resource.json">Localhost:8788</button>
      <button class="test-url-btn" data-url="//test-resource.json">Protocol-relative</button>
      <button class="test-url-btn" data-url="test-resource.json">Simple Relative</button>
    </div>
  </div>
  
  <script>
    // Set debug info
    document.getElementById('load-time').textContent = new Date().toISOString();
    document.getElementById('current-url').textContent = window.location.href;
    
    // Set up URL preset buttons
    document.querySelectorAll('.test-url-btn').forEach(button => {
      button.addEventListener('click', () => {
        const url = button.getAttribute('data-url');
        document.getElementById('resource-url').value = url;
      });
    });
    
    // Main resource loading function
    async function loadResource(url) {
      const resultDiv = document.getElementById('resource-result');
      resultDiv.style.display = 'block';
      
      console.group('Resource Loading Test');
      console.log('Loading from URL:', url);
      
      // Show loading status
      resultDiv.innerHTML = `
        <div>Loading resource from: ${url}</div>
        <div class="debug-info">Please wait...</div>
      `;
      
      try {
        // Add timestamp to prevent caching
        const timestampedUrl = url.includes('?') 
          ? `${url}&t=${Date.now()}` 
          : `${url}?t=${Date.now()}`;
        
        console.log('Fetch request URL:', timestampedUrl);
        
        // Attempt to fetch the resource
        const response = await fetch(timestampedUrl, {
          method: 'GET',
          headers: {
            'Accept': 'application/json',
            'Cache-Control': 'no-cache, no-store, must-revalidate'
          },
          cache: 'no-store',
          mode: 'cors',
          credentials: 'omit'
        });
        
        console.log('Response status:', response.status, response.statusText);
        console.log('Response headers:', [...response.headers.entries()]);
        
        if (response.ok) {
          // Handle successful response
          try {
            const data = await response.json();
            console.log('Response data:', data);
            
            resultDiv.innerHTML = `
              <div class="success">Resource loaded successfully!</div>
              <div>Status: ${response.status} ${response.statusText}</div>
              <strong>Response Data:</strong>
              <pre>${JSON.stringify(data, null, 2)}</pre>
            `;
          } catch (jsonError) {
            // Handle invalid JSON
            const text = await response.text();
            console.error('JSON parse error:', jsonError);
            console.log('Response text:', text);
            
            resultDiv.innerHTML = `
              <div class="error">Resource loaded but contains invalid JSON</div>
              <div>Status: ${response.status} ${response.statusText}</div>
              <strong>Response Text:</strong>
              <pre>${text}</pre>
            `;
          }
        } else {
          // Handle error response
          let errorText;
          try {
            errorText = await response.text();
          } catch (e) {
            errorText = 'No response text available';
          }
          
          console.error('Error response:', errorText);
          
          resultDiv.innerHTML = `
            <div class="error">Error loading resource</div>
            <div>Status: ${response.status} ${response.statusText}</div>
            <strong>Error Details:</strong>
            <pre>${errorText}</pre>
          `;
        }
      } catch (error) {
        // Handle network/fetch errors
        console.error('Fetch error:', error);
        
        resultDiv.innerHTML = `
          <div class="error">Network error while loading resource</div>
          <div>Error: ${error.name}: ${error.message}</div>
          <div class="debug-info">
            This typically occurs due to:
            <ul>
              <li>CORS issues (if loading from a different origin)</li>
              <li>Network connectivity problems</li>
              <li>Server unavailability</li>
            </ul>
            Check the browser console for more details.
          </div>
        `;
      }
      
      console.groupEnd();
    }
    
    // Add event listener for the load button
    document.getElementById('load-resource').addEventListener('click', () => {
      const url = document.getElementById('resource-url').value.trim();
      if (url) {
        loadResource(url);
      } else {
        alert('Please enter a resource URL');
      }
    });
    
    // Initialize with default URL
    document.getElementById('resource-url').focus();
  </script>
</body>
</html>